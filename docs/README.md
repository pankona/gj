# 設計のメモなどを書くところ

## 素材など

- ChatGPT で絵を描いてもらう
- [イラストエイトさん](https://illust8.com/contents/3731)
  - バリケードや手のひらの絵
 
## スプライトをクリックしたらコールバックする

### 概要

「if クリックを検知したら～」という処理をメインループに書き下していくと、クリック判定の分岐があちこちに散らばってしまう。
もうちょっと見通しを良くするために、各オブジェクトには「onClick」みたいなメソッドを持たせておき、クリックされたらその関数をコールバックするような仕組みにしておきたい。

### 設計

あらゆるものがクリック対象になるわけではないので、クリック対象はつけ外しができる必要がある。AddEventListener/RemoveEventListener のノリで実装すればよさそう。

スプライトが重なっているとき、一番手前のスプライトだけクリックを受けて後ろのスプライトには効果が及ばないようにするのが良いような気がする。JavaScript でいうところの event.preventDefault がデフォルトの振る舞いであるようなイメージ。
これをやるためには、複数のスプライトが AddEventListener されていたとして、誰が一番手前にいるのかというのを処理する必要がある。z-index のようなものをスプライトには持たせておき、これで AddEventListener されたものをあらかじめソートしておく (新規に AddEventListener されたときにソートする) のが良いような気がしている。

クリックイベントが発生したとき、AddEventListener されたオブジェクト全てに対して以下の処理を行う。

- クリック位置が、自身に重なっているか？
  - YES ならば当該オブジェクトの onClick を呼び出し、ループを終了する
  - No ならば、次のオブジェクトに対する評価に移る

### 懸念など

オブジェクトの数が多くなってくるとループが長くなるので、パフォーマンスに影響するかもしれない？

- 100も200もクリック対象がある、という状況は考えにくいというか、そういう UI にしちゃいけないような気はする

## 音を出す仕組み

### 概要

何かが起きたら音を出したいことがある。効果音も BGM もある。
これも if 文で分岐しだすと見通しが悪くなるような気がしている。そもそも音とゲームロジックはなるべく分離しておきたい。

### 設計

「何かが起きる」はイベントとして表現する。pubsub じみた仕組みを導入し、イベントをサブスクライブする誰かがいるような構成にする。
「音を鳴らすやつ」はイベントを購読している。イベントを見て、対応する音を鳴らす仕組みにする。

### 懸念など

イベントは channel を用いた queue 構造で表せばいいかな？と思っているが、一時にあまりにもたくさんのイベントがつまれてしまうと、同フレームで処理しきれなくなってしまうようなことも起こるかもしれない？

## コールバックとイベントキューの扱いの違い

クリックも音を出すのも見ようによっては同じイベントであるから、どちらもコールバック (あるいはイベントキュー) の形でじっそうすればいいんじゃないか、という話があるかもしれない。

コールバックとイベントキューの違いは、「同一フレーム内で絶対に処理したいかどうか」というのがポイントであると考えている。クリックイベントはただちに実行してほしいが、音を出すとかその他のゲームロジックとやや離れたところにある処理 (いわゆるビュー) は、圧倒的に遅れることがないのであれば、ちょっと遅れて実行されても良いという発想。

プレイヤーの HP が 0 になったら、その瞬間にプレイヤーは死亡扱いにしたい。でも死亡時の音の再生であるとか、アニメーションであるとかは数フレーム遅れても差し支えないのではないか？みたいなところである (真偽不明) 。

## アニメーションの仕組み

### 概要

https://ebitengine.org/ja/examples/animation.html が大いに参考になる。だいたい以下のやり方をする。
- アニメーションセット (仮称) となる画像を用意しておく。
- image.SubImage を使って、表示する位置を次々に切り替えていく。

### 設計

- 一生ループしてほしいアニメーションと、一回ループすればよいアニメーションがあるはず。これらは切り替えられるようなオプションがあると良さそう
- アニメーションを取り入れだすと画像の量が多くなりがちかと思う。アニメーションさせたいタイミングで画像を読み込むとゲームの動作に影響が出そうなので、初期化時に必要な画像は一気に読み込んでおくってやる必要がありそう。
- これもイベントドリブンで駆動するのがいいのかもしれない。
  - アニメーションの長さはゲームロジックに関わる場合があるが、アニメーションの内容そのものはゲームロジックに関わらない。ゲームロジックとして「このアニメーションが終わってから次の処理にいく」ということをやりたいケースがありそうだが、所要時間をゲームロジックで表現し、アニメーションはそれにフィットするように作るのが良いかと思う。ロジックが主、アニメーションが従。

### 懸念など

- 素材がない

## クリックとタップは同一視する

### 概要

ウェブ上で動作するし、スマホでも操作できるゲームにしようという目論見がある。
- スマホだと基本的にタップ操作しかできない。マルチタッチや長押しもあるっちゃあるが。
- なので、シンプルに「タップだけで操作できる」というところを目指す。デバッグしやすいように、PC 上ではクリックで操作できるようにしておく。

### 設計

クリックなのかタップなのかというのは区別しなくて良いということになるので、これらは同一に扱うようにラッパーかなにかを仕込んでおこう。
あとキーボード操作とか十字キーの操作とかは登場させない操作体系にするということを念頭に置いておく。

### 懸念など

操作体系としてはシンプルで良いが、これだと足りない！っていうことになりそうな気がしないでもない。
画面上にボタンを表示して、タップで押させるというアイデアもあるかもしれない。あとドラッグ操作くらいは許容にする可能性はある？ (スマホでドラッグはどうやる？)

## package 構成

### 概要

いったん main package 一本で行く。このモジュールは将来使いまわしができそうだから別の package にしとこー、みたいのは脱稿してから考えよう。

## テストの実行

ebitengine を使ったコードに対して `go test ./...` とやると、描画に関連したエラーがいくつか出ることがある。これは ebitengine が init の中でいくらか描画関連の処理を呼び出すことが理由であるようだ。なのでテストを実行するときにはいくらかお膳立てをしておく必要がある。

詳細は github actions のテスト実行の部分を参照のこと。

## 敵の行動アルゴリズム

まず、いったん3種類くらいの敵キャラがいることを考える。それぞれ微妙に異なった特徴をもっていると想定する。
ここでは便宜的に「赤虫」「青虫」「緑虫」と呼称する。

暫定で以下のようなアルゴリズムで動くとしてみる。

- 共通動作
  - 前にすでに他の虫がいる場合、
    - その場で待機する
    - (Option) ちょっと迂回するような動きで前に進める道を探す

- 赤虫
  - 家に向かって一直線に進む。壁などにぶつかったら、ぶつかったものに対して攻撃を行う。
  - 攻撃は一定時間ごとに行う。攻撃範囲はせまい。自身の周囲ちょっとくらい。
  - 体力は少ない。
  - ただし大量に出現する。
  - 動きは速い。

- 青虫
  - 最寄りの障害物に向かって進む。障害物にぶつかったら、ぶつかったものに対して攻撃を行う。
  - 攻撃は一定時間ごとに行う。攻撃機範囲はせまい。自身の周囲ちょっとくらい (赤虫と同じ)。
  - 体力は赤虫よりもちょっと多い。
  - 赤虫より多く出現する。
  - 動きの速さは普通。

- 緑虫
  - 家に向かって一直線に進む。
  - 攻撃は一定時間ごとに行う。攻撃範囲が広い。飛び道具のようなものを放つ。
  - 攻撃範囲に任意の障害物が入ったとき、その障害物に向かって攻撃を行う。
  - 体力は青虫よりも多い。
  - 出現頻度は低い。
  - 動きは遅い。

## プレイヤーによる敵への攻撃

### 概要

プレイヤーが敵に対して攻撃を行うことができる。攻撃の方法は、クリックした位置を中心に一定範囲内に攻撃を行うというものとする。
いくらかクールタイムを設けて、連続して攻撃を行えないようにする。何ウェーブか過ぎたあとにレベルアップさせることで、攻撃範囲や攻撃力を上げることができるようにするのもありかも。

### 設計

クリックによって攻撃を発動するということと、各建物やユニットをクリックすることで情報を表示するという操作が競合していることに留意する必要がある。
ここでは、ウェーブ中はクリックした位置に攻撃を発動すると共に、クリックした位置に建物やユニットが存在する場合は情報表示も行うという仕様にする。
ウェーブ中でないときは、クリックした位置に建物やユニットが存在する場合は情報表示を行う。攻撃は行わない。

その他のよくばり案
- (Option) 攻撃のクールタイムも画面上のどこかに表示したい
- (Option) 攻撃力の情報もどこかで確認できるようにしたい

攻撃のための OnClick をどこで受けるか
- 素朴にやると、各ユニットの onClick で攻撃のためのロジックを実装することになるが、疎な設計でなく、拡張がつらくなりそうな気がする
- ここでは、「攻撃のためのクリックを受け取るオブジェクト」として、透明なペインを画面全体に敷き詰めるやり方でやってみようと思う
  - 透明なペインは、画面全体に敷き詰める。そいつが Clickable を実装しているとする
  - ZIndex がそこそこ高い (少なくとも画面上の建物やユニットよりは高い)
  - info を表示したいのであれば、「クリックを貫通」させる必要があるかもしれない

## 場に障害物を配置する

バリケードなどの建物は、自由な位置にプレイヤーが配置できるものとする。配置には一定のコストが掛かり、無尽蔵に置くことはできない。
- 敵を倒してお金を得て、そのお金でバリケードを買うという仕組みであるとか
- あるいはウェーブ毎に一定の「ポイント」のようなものがもらえて、それで買うであるとか

### いつ置くか

ウェーブの合間にだけ置くことができるというパターンと、ウェーブ中でも置くことができるというパターンが考えられそう。
ウェーブ中は敵が現れるので、「敵に重なるような置き方をしたときにどういう挙動にするか」を設計する必要があるかもしれない。単純に置けないってやるのでもいいかもしれないが。

今回は単純化のために「ウェーブの間にだけ配置することができる」として設計を進めてみる。

### どうやって置くか

以下の手順で置く
- 操作パネルからバリケードを選択する。
- 場を一回クリックする。これで仮ぎめ状態になる。
- OK ボタンをクリックすると実際に配置される。

操作パネルには建物の情報が表示されている場合がある。常に建築メニューが出ているわけではないことを想定する。つまり「建築メニューを呼び出す」操作が必要。
- 家をクリックしたときに建築メニューが一緒に表示される、みたいなやり口でもいいかもしれない。家はゲームが続いている限り絶対に存在するので一応成り立つとは思う (家がないということはゲームオーバーになっている)
  - コマンドセンター的な役割
  - 直感的にわかりやすいかと言われるとよくわからないが、まあウェーブ中に家の状態は確認したくなるんじゃないかな？そんときに自然と「おっ、メニュー出てるやんけ」って気づいてもらえそう。
- 専用のボタンを適当な場所にしつらえるというのもありそう (BUILD ボタン的な)
  - わかりやすいとは思うが UI 的にはスマートではなさそう
  - ボタンが空中に浮いている必然性がないというかなんというか
  - なるべく操作は操作パネル内で完結させたい気持ちはある
- 場の空いているところをクリックしたら建築メニューを出すというパターンもありそう
  - これはこれでありだが、わかりにくい気はする
  - 画面が建物でいっぱいになると操作が難しくなるかもしれない？

今回は「家をクリックしたときに、家と一緒に建築メニューを表示する」という作戦で行こうと思う
- バリケードなど、家以外の建物をクリックしたときには「修理する」みたいなメニューを出してもいいよね
- 家も修理できる仕様にしとけばいいかも

### どうやって置くかの備考

- 配置位置の仮ぎめは、特にスマホでプレイするときに大事な気がしている。たとえばクリック一発で場所が決まってしまうと「あーそこじゃなかったんですけど」みたいなことになりがちだと思う。
- PC 版ならば、マウスのホバー時に建物が置かれる予定の位置を示すことができそう。だがスマホにマウスのホバーにあたるものはないのでね…。

## ウェーブの進行と建築フェーズ

ゲームは「建築フェーズ」と「戦闘フェーズ」を繰り返すことで進行する。最初に建築フェーズがあり、準備ができたら戦闘フェーズに移行する。
- ウェーブを終えると一定のクレジットが得られるものとする。このクレジットを使ってバリケードを置いたり、プレイヤーの攻撃をアップグレードすることができる。
- ウェーブ毎に実行できる建築やレベルアップはランダムで候補がピックアップされる。ヴァンサバのレベルアップとか Slay the Spire の戦闘後のカード選択とかそういうノリ。
  - 建物を建築する (バリケード、攻撃タワー、などなどがありえる)
  - プレイヤーの攻撃を強化する
  - 建物の修理
  - etc
- n 回ウェーブを乗り越えるとゲームクリアになる

## 建物の修理

建物の修理には一定のコストがかかるものとする。これは損傷が軽かろうが重かろうが一定のコストがかかるとしておく。
ギリギリまで耐えてから修理するほうがコスパが良いが、ウェーブ中に修理することはできないので微妙なヘルスでウェーブに挑むと建物がぶっ壊れてしまうという心配がある。というジレンマをもたらすのが目的。そういう意図もあり、建物は修理よりも新しく建てるほうがコストが掛かるということにしておく。

## 建物の種類

建物の種類について検討する

### バリケード

敵を妨害する。体力がそこそこあり、大きさもまあまあ。
比較的安価であるとする。

### 単体攻撃する塔

塔を中心に一定の攻撃範囲がある。攻撃範囲に入った敵 (単品) を攻撃する。
- クールダウンはそこそこ短い。なぜなら単品を狙う攻撃なので、大量に押し寄せる虫に対してはそこそこ頻繁に攻撃しないと空気になってしまうから。
- 攻撃力はそこまで高くなくていいかもしれない。
- 体力はバリケードよりは弱い。そしてやや細くて敵の進行妨害にはあまり貢献しないものとする。

### 範囲攻撃する兵器

兵器を中心に一定の攻撃範囲がある。攻撃範囲に入った敵を攻撃する。
- 特定の敵を攻撃するが、範囲攻撃をする。つまり周りを巻き込む。
- 攻撃範囲が広いが、超近距離は攻撃できないものとする。
- クールダウンがそこそこ長い。
- 攻撃力はまあまあある。一発で赤虫を倒せるくらいはある。

### 鈍足にするトラップ

なんちゃらホイホイのイメージ
- 上を通る虫は移動がゆっくりになる
- いっぱい並べることができる
- 攻撃されない

攻撃されない建物はいままでの法則とちょっと異なるので、まったく異なるメカニズムが必要そう。いったん実装は見送る。
